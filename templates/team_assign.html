{% extends "base.html" %}
{% load static %}
{% block content %}
  <div>
    <p class="page-title">팀별 멤버 구성</p>
  </div>
  <div class="team-setting">
    <form id="team-form" method="post" action="{% url 'runres:save_team_members' %}">
      {% csrf_token %}

      <div class="board">
        <!-- 미배정 멤버 영역 -->
        <div class="column">
          <div class="column-header">미배정 멤버</div>
          <div class="dropzone" data-team-id="">
            {% for member in members %}
              {# member.current_team_id 가 없거나 None 이면 미배정으로 가정 #}
              {% if not member.current_team_id %}
                <div class="member-card" draggable="true" data-member-id="{{ member.id }}" id="member-{{ member.id }}">
                  {{ member.username }}
                </div>
              {% endif %}
              <input type="hidden" name="member_team_{{ member.id }}" id="input-member-{{ member.id }}" value="{{ member.current_team_id|default_if_none:'' }}">
            {% endfor %}
          </div>
        </div>

        <!-- 팀별 영역 -->
        {% for team in teams %}
          <div class="column">
            <div class="column-header">{{ team.team_name }}</div>
            <div class="dropzone" data-team-id="{{ team.team_id }}">
              {# 이미 이 팀에 배정된 멤버 표시 #}
              {% for member in members %}
                {% if member.current_team_id == team.team_id %}
                  <div class="member-card" draggable="true" data-member-id="{{ member.id }}" id="member-{{ member.id }}">
                    {{ member.username }}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="submit-area">
        <button type="submit" class="submit-btn">
          <p class="btn-text">저장하기</p>
        </button>
      </div>
    </form>
  </div>
  <script>
    // 드래그 대상
    let draggedCard = null;

    // 멤버 카드 드래그 설정
    document
      .querySelectorAll('.member-card')
      .forEach(card => {
        card.addEventListener('dragstart', (e) => {
          draggedCard = card;
          card
            .classList
            .add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });

        card.addEventListener('dragend', () => {
          if (draggedCard) {
            draggedCard
              .classList
              .remove('dragging');
            draggedCard = null;
          }
        });
      });

    // 드랍존 설정
    document
      .querySelectorAll('.dropzone')
      .forEach(zone => {
        zone.addEventListener('dragover', (e) => {
          e.preventDefault(); // drop 허용
          e.dataTransfer.dropEffect = 'move';
          zone
            .classList
            .add('dragover');
        });

        zone.addEventListener('dragleave', () => {
          zone
            .classList
            .remove('dragover');
        });

        zone.addEventListener('drop', (e) => {
          e.preventDefault();
          zone
            .classList
            .remove('dragover');
          if (!draggedCard) 
            return;
          
          // 카드 위치 이동
          zone.appendChild(draggedCard);

          // 드랍된 팀 id 가져오기
          const teamId = zone.dataset.teamId || "";

          // 멤버 hidden input 업데이트
          const memberId = draggedCard.dataset.memberId;
          const hiddenInput = document.getElementById('input-member-' + memberId);
          if (hiddenInput) {
            hiddenInput.value = teamId;
          }
        });
      });
  </script>
{% endblock content %}
