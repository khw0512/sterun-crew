{% extends "base.html" %}
{% load static %}
{% block content %}

  {% csrf_token %}
  <div class="space-h30"></div>
  <div class="flex-container container-400">
    <div class="bingo-title">{{ user.last_name }}{{ user.first_name }}
      님의 빙고</div>
  </div>

  <div class="bingo-board fade-in-up-short">
    <div class="bingo-row">
      {% for item in bingo_item_1r %}
        <label for="{{ item.bingo_item.item_id }}">
          <div class="bingo-col" id="item{{ item.bingo_item.item_id }}">
            <input type="checkbox" name="item" id="{{ item.bingo_item.item_id }}" data-post-id="{{ item.bingo_item.item_id }}" {% if item.completed %} checked="checked" {% endif %}>
            {{ item.bingo_item.content }}
            <div id="bingo-img{{ item.bingo_item.item_id }}" class="bingo-img">
              <img class="bingo-stamp" src="{% static "img/Ellipse-1.svg" %}" alt="main-img" height="auto," width="auto">
            </div>
          </div>
        </label>

      {% endfor %}
    </div>
    <div class="bingo-row">
      {% for item in bingo_item_2r %}
        <label for="{{ item.bingo_item.item_id }}">
          <div class="bingo-col" id="item{{ item.bingo_item.item_id }}">
            <input type="checkbox" name="item" id="{{ item.bingo_item.item_id }}" data-post-id="{{ item.bingo_item.item_id }}" {% if item.completed %} checked="checked" {% endif %}>
            {{ item.bingo_item.content }}
            <div id="bingo-img{{ item.bingo_item.item_id }}" class="bingo-img">
              <img class="bingo-stamp" src="{% static "img/Ellipse-1.svg" %}" alt="main-img" height="auto," width="auto">
            </div>
          </div>
        </label>
      {% endfor %}
    </div>
    <div class="bingo-row">
      {% for item in bingo_item_3r %}
        <label for="{{ item.bingo_item.item_id }}">
          <div class="bingo-col" id="item{{ item.bingo_item.item_id }}">
            <input type="checkbox" name="item" id="{{ item.bingo_item.item_id }}" data-post-id="{{ item.bingo_item.item_id }}" {% if item.completed %} checked="checked" {% endif %}>
            {{ item.bingo_item.content }}
            <div id="bingo-img{{ item.bingo_item.item_id }}" class="bingo-img">
              <img class="bingo-stamp" src="{% static "img/Ellipse-1.svg" %}" alt="main-img" height="auto," width="auto">
            </div>
          </div>
        </label>
      {% endfor %}
    </div>
    <div class="bingo-row">
      {% for item in bingo_item_4r %}
        <label for="{{ item.bingo_item.item_id }}">
          <div class="bingo-col" id="item{{ item.bingo_item.item_id }}">
            <input type="checkbox" name="item" id="{{ item.bingo_item.item_id }}" data-post-id="{{ item.bingo_item.item_id }}" {% if item.completed %} checked="checked" {% endif %}>
            {{ item.bingo_item.content }}
            <div id="bingo-img{{ item.bingo_item.item_id }}" class="bingo-img">
              <img class="bingo-stamp" src="{% static "img/Ellipse-1.svg" %}" alt="main-img" height="auto," width="auto">
            </div>
          </div>
        </label>
      {% endfor %}
    </div>
    <div class="bingo-row">
      {% for item in bingo_item_5r %}
        <label for="{{ item.bingo_item.item_id }}">
          <div class="bingo-col" id="item{{ item.bingo_item.item_id }}">
            <input type="checkbox" name="item" id="{{ item.bingo_item.item_id }}" data-post-id="{{ item.bingo_item.item_id }}" {% if item.completed %} checked="checked" {% endif %}>
            {{ item.bingo_item.content }}
            <div id="bingo-img{{ item.bingo_item.item_id }}" class="bingo-img">
              <img class="bingo-stamp" src="{% static "img/Ellipse-1.svg" %}" alt="main-img" height="auto" width="auto">
            </div>
          </div>
        </label>
      {% endfor %}
    </div>
  </div>
  {% if len != 5 %}
    <a href="{% url 'bingo:create_bingo' user.pk %}">
      <div class="create-bingo-btn">빙고 만들기</div>
    </a>
  {% endif %}
  {% if user_matched == 1 %}
    <div class="go-center">
      <button id="kakao-share-btn" class="kakao-btn">
        <img src="{% static "img/KakaoTalk_logo.png" %}" alt="" height="30px" width="30px">
        <div>카카오톡 공유</div>
      </button>
    </div>
  {% else %}
    <div class="hidden">
      <button id="kakao-share-btn">
        <div>카카오톡 공유</div>
      </button>
    </div>
  {% endif %}
  <!-- 모달 오버레이 -->
  <div id="NoModal" class="modal-overlay">
    <div class="modal-box">
      <div class="flex-row-bt">
        <h3>취소하기</h3>
        <button type="button" class="delmodal-btn" id="closeNoModal">X</button>
      </div>
      <p>정말 취소하시겠습니까?</p>
      <div class="modal-buttons">
        <button type="button" class="bingocheck-btn" id="bingo-no">취소</button>
      </div>
    </div>
  </div>
  <div id="YesModal" class="modal-overlay">
    <div class="modal-box">
      <div class="flex-row-bt">
        <h3>완료하기</h3>
        <button type="button" class="delmodal-btn" id="closeYesModal">X</button>
      </div>
      <p>정말 완료하시겠습니까?</p>
      <div class="modal-buttons">
        <button type="button" class="bingocheck-btn" id="bingo-yes">완료</button>
      </div>
    </div>
  </div>
  {% csrf_token %}
  <input type="hidden" id="csrf-token" value="{{ csrf_token }}">

  <script>
    document
      .getElementById('kakao-share-btn')
      .addEventListener('click', function () {
        Kakao
          .Share
          .sendDefault({
            objectType: 'feed',
            content: {
              title: "Running-Bingo",
              description: "{{ user.username }}님의 빙고를 확인해 보세요:)",
              imageUrl: "https://joollab.com/static/img/logo2%40.png",
              link: {
                mobileWebUrl: "https://joollab.com/bingo/" + "{{ user.pk }}",
                webUrl: "https://joollab.com/bingo/" + "{{ user.pk }}"
              }
            },
            buttons: [
              {
                title: '보러가기',
                link: {
                  mobileWebUrl: "https://joollab.com/bingo/" + "{{ user.pk }}",
                  webUrl: "https://joollab.com/bingo/" + "{{ user.pk }}"
                }
              }
            ]
          });
      });
  </script>
  <script>
    const nomodal = document.getElementById("NoModal");
    const yesmodal = document.getElementById("YesModal");

    function closeYesModal() {
      yesmodal
        .classList
        .remove("active");
    }

    function closeNoModal() {
      nomodal
        .classList
        .remove("active");
    }

    const csrfToken = document
      .getElementById('csrf-token')
      .value;
    const user_matched = "{{ user_matched }}";
    const user_id = "{{ user_id }}";

    // 현재 어떤 체크박스를 처리 중인지 저장할 변수들
    let currentCheckbox = null;
    let currentBingoImg = null;
    let currentBingoId = null;

    // ✅ 공통으로 서버 업데이트하는 함수
    function updateBingoStatus(isChecked) {
      if (!currentBingoId) 
        return;
      
      return fetch("/bingo/update-public-status/" + user_id, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({bingo_id: currentBingoId, is_checked: isChecked})
      })
        .then(response => response.json())
        .then(data => {
          console.log("업데이트 결과:", data);
        })
        .catch(err => console.error("에러:", err));
    }

    // ✅ 체크박스 루프
    for (let i = 1; i < 26; i++) {
      const checkbox = document.getElementById(i);
      const bingo_img = document.getElementById('bingo-img' + i);

      if (!checkbox || !bingo_img) 
        continue;
      
      // 초기 상태에 따라 이미지 표시
      bingo_img.style.display = checkbox.checked
        ? 'block'
        : 'none';

      checkbox.addEventListener('change', function () {
        if (user_matched != 1) {
          // user_matched 가 1이 아닌 경우 아무 것도 하지 않음
          return;
        }

        // 현재 클릭된 정보 저장
        currentCheckbox = this;
        currentBingoImg = bingo_img;
        currentBingoId = this.dataset.postId;

        if (this.checked === false) {
          // ✅ 체크 해제 → NoModal 오픈
          nomodal
            .classList
            .add("active");
        } else {
          // ✅ 체크 → YesModal 오픈
          yesmodal
            .classList
            .add("active");
        }
      });
    }

    /* ==========================
       ❌ NoModal 이벤트 (한 번만 등록)
       ========================== */

    // "예, 비공개로 돌릴게요" 같은 버튼
    document
      .getElementById("bingo-no")
      .addEventListener("click", function (e) {
        if (!currentCheckbox || !currentBingoImg) 
          return;
        
        updateBingoStatus(false).then(() => {
          currentCheckbox.checked = false;
          currentBingoImg.style.display = 'none';
          closeNoModal();
        });
      });

    // 모달 바깥 눌렀을 때 닫기 + 원상복구(취소)
    nomodal.addEventListener("click", function (e) {
      if (e.target === this) {
        closeNoModal();
        if (currentCheckbox) {
          currentCheckbox.checked = true; // 해제 시도 취소 → 다시 체크
          if (currentBingoImg) 
            currentBingoImg.style.display = 'block';
          }
        }
    });

    // X 버튼 눌렀을 때 닫기 + 원상복구(취소)
    document
      .getElementById("closeNoModal")
      .addEventListener("click", function (e) {
        closeNoModal();
        if (currentCheckbox) {
          currentCheckbox.checked = true;
          if (currentBingoImg) 
            currentBingoImg.style.display = 'block';
          }
        });

    /* ==========================
       ✅ YesModal 이벤트 (한 번만 등록)
       ========================== */

    // "예, 공개로 할게요" 같은 버튼
    document
      .getElementById("bingo-yes")
      .addEventListener("click", function (e) {
        if (!currentCheckbox || !currentBingoImg) 
          return;
        
        updateBingoStatus(true).then(() => {
          currentCheckbox.checked = true;
          currentBingoImg.style.display = 'block';
          closeYesModal();
        });
      });

    // 모달 바깥 눌렀을 때 닫기 + 원상복구(취소)
    yesmodal.addEventListener("click", function (e) {
      if (e.target === this) {
        closeYesModal();
        if (currentCheckbox) {
          currentCheckbox.checked = false; // 체크 시도 취소 → 다시 해제
          if (currentBingoImg) 
            currentBingoImg.style.display = 'none';
          }
        }
    });

    // X 버튼 눌렀을 때 닫기 + 원상복구(취소)
    document
      .getElementById("closeYesModal")
      .addEventListener("click", function (e) {
        closeYesModal();
        if (currentCheckbox) {
          currentCheckbox.checked = false;
          if (currentBingoImg) 
            currentBingoImg.style.display = 'none';
          }
        });
  </script>

{% endblock content %}
